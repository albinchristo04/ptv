name: Generate SEO Metadata

on:
  push:
    branches:
      - main
    paths:
      - 'events.json'
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate-seo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Create script directory
        run: mkdir -p scripts
      
      - name: Create SEO generator script
        run: |
          cat > scripts/generate-seo.js << 'EOF'
          const fs = require('fs');
          const https = require('https');

          const SOURCE_URL = 'https://raw.githubusercontent.com/${{ github.repository }}/main/events.json';
          const OUTPUT_FILE = 'seo-metadata.json';
          const DOMAIN = 'https://tarjetarojaenvivo.live';

          // Primary Spanish keywords for Bing optimization
          const PRIMARY_KEYWORDS = [
            'rojadirecta',
            'tarjeta roja',
            'rojadirecta tv',
            'pirlotv',
            'tarjeta roja tv',
            'rojadirecta en vivo',
            'tarjeta roja directa',
            'tarjeta roja en vivo',
            'pirlo tv rojadirecta',
            'roja directa pirlo'
          ];

          function fetchJSON(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (e) {
                    reject(e);
                  }
                });
              }).on('error', reject);
            });
          }

          function generateSlug(text) {
            return text.toLowerCase()
              .normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '')
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '');
          }

          function formatDate(timestamp) {
            return new Date(timestamp * 1000).toISOString();
          }

          function generateMetadata(stream, category) {
            const { id, name, tag, poster, uri_name, starts_at, ends_at, category_name, viewers } = stream;
            const eventDate = new Date(starts_at * 1000);
            const endDate = new Date(ends_at * 1000);
            const slug = generateSlug(name);
            const teams = name.split(' vs. ').map(t => t.trim());
            const isVersusMatch = teams.length === 2;

            const eventKeywords = [
              ...PRIMARY_KEYWORDS.slice(0, 8),
              name,
              ...teams,
              category_name,
              'ver online gratis',
              'en vivo gratis',
              tag
            ];

            return {
              id,
              slug,
              uri_name,
              canonical_url: `${DOMAIN}/eventos/${uri_name}`,
              meta: {
                title: `${name} EN VIVO - Tarjeta Roja TV | Rojadirecta Gratis`,
                description: `âš½ Ver ${name} en vivo gratis por Tarjeta Roja TV. ${isVersusMatch ? `${teams[0]} vs ${teams[1]}` : name} transmisiÃ³n en directo.`,
                keywords: eventKeywords.join(', '),
                robots: 'index, follow'
              },
              og: {
                type: 'website',
                url: `${DOMAIN}/eventos/${uri_name}`,
                title: `${name} EN VIVO âš½ Tarjeta Roja TV`,
                description: `Ver ${name} en vivo gratis.`,
                image: poster,
                site_name: 'Tarjeta Roja En Vivo',
                locale: 'es_ES'
              },
              twitter: {
                card: 'summary_large_image',
                site: '@tarjetarojatvs',
                title: `${name} EN VIVO`,
                description: `Ver ${name} en vivo gratis.`,
                image: poster
              },
              schema: {
                '@context': 'https://schema.org',
                '@type': 'SportsEvent',
                name: name,
                description: `TransmisiÃ³n en vivo de ${name}`,
                startDate: formatDate(starts_at),
                endDate: formatDate(ends_at),
                eventStatus: 'https://schema.org/EventScheduled',
                eventAttendanceMode: 'https://schema.org/OnlineEventAttendanceMode',
                location: {
                  '@type': 'VirtualLocation',
                  url: `${DOMAIN}/eventos/${uri_name}`
                },
                image: poster,
                organizer: {
                  '@type': 'Organization',
                  name: 'Tarjeta Roja En Vivo',
                  url: DOMAIN
                },
                ...(isVersusMatch && {
                  competitor: teams.map(team => ({ '@type': 'SportsTeam', name: team })),
                  homeTeam: { '@type': 'SportsTeam', name: teams[0] },
                  awayTeam: { '@type': 'SportsTeam', name: teams[1] }
                }),
                sport: category_name
              },
              seo: {
                breadcrumbs: [
                  { name: 'Inicio', url: DOMAIN },
                  { name: category_name, url: `${DOMAIN}/categoria/${generateSlug(category_name)}` },
                  { name: name, url: `${DOMAIN}/eventos/${uri_name}` }
                ],
                h1: `${name} EN VIVO`,
                h2: `Ver ${name} Online Gratis`
              },
              event: {
                name,
                category: category_name,
                broadcaster: tag,
                start_time: formatDate(starts_at),
                end_time: formatDate(ends_at),
                duration_minutes: Math.round((ends_at - starts_at) / 60),
                status: starts_at < Date.now() / 1000 ? (ends_at > Date.now() / 1000 ? 'live' : 'completed') : 'upcoming',
                viewers: viewers || '0',
                ...(isVersusMatch && {
                  home_team: teams[0],
                  away_team: teams[1]
                })
              },
              technical: {
                last_modified: new Date().toISOString(),
                priority: stream.always_live ? 0.9 : 0.8,
                changefreq: stream.always_live ? 'always' : 'hourly',
                hreflang: 'es'
              },
              bing: {
                news_keywords: eventKeywords.slice(0, 10).join(', ')
              }
            };
          }

          async function generateSEOData() {
            try {
              console.log('Fetching events data...');
              const data = await fetchJSON(SOURCE_URL);

              const seoData = {
                generated_at: new Date().toISOString(),
                total_events: 0,
                categories: [],
                events: []
              };

              for (const category of data.events.streams) {
                const categoryMeta = {
                  id: category.id,
                  name: category.category,
                  slug: generateSlug(category.category),
                  event_count: category.streams.length,
                  always_live: category.always_live,
                  meta: {
                    title: `${category.category} EN VIVO - Tarjeta Roja TV`,
                    description: `Ver ${category.category} en vivo gratis.`,
                    keywords: `${category.category}, tarjeta roja, rojadirecta`
                  }
                };

                seoData.categories.push(categoryMeta);

                for (const stream of category.streams) {
                  const eventMeta = generateMetadata(stream, category.category);
                  seoData.events.push(eventMeta);
                  seoData.total_events++;
                }
              }

              fs.writeFileSync(OUTPUT_FILE, JSON.stringify(seoData, null, 2));
              console.log(`âœ… Generated SEO metadata for ${seoData.total_events} events`);

              const sitemapUrls = seoData.events.map(e => ({
                loc: e.canonical_url,
                lastmod: e.technical.last_modified,
                changefreq: e.technical.changefreq,
                priority: e.technical.priority
              }));

              fs.writeFileSync('sitemap-urls.json', JSON.stringify(sitemapUrls, null, 2));
              console.log('ðŸ—ºï¸  Generated sitemap URLs');

              return seoData;
            } catch (error) {
              console.error('âŒ Error:', error.message);
              process.exit(1);
            }
          }

          generateSEOData();
          EOF
      
      - name: Generate SEO Metadata
        run: node scripts/generate-seo.js
      
      - name: Generate XML Sitemap
        run: |
          cat > generate-sitemap.js << 'EOF'
          const fs = require('fs');
          
          const urls = JSON.parse(fs.readFileSync('sitemap-urls.json', 'utf8'));
          
          let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
          xml += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"\n';
          xml += '        xmlns:xhtml="http://www.w3.org/1999/xhtml"\n';
          xml += '        xmlns:news="http://www.google.com/schemas/sitemap-news/0.9">\n';
          
          urls.forEach(url => {
            xml += '  <url>\n';
            xml += `    <loc>${url.loc}</loc>\n`;
            xml += `    <lastmod>${url.lastmod}</lastmod>\n`;
            xml += `    <changefreq>${url.changefreq}</changefreq>\n`;
            xml += `    <priority>${url.priority}</priority>\n`;
            xml += '  </url>\n';
          });
          
          xml += '</urlset>';
          
          fs.writeFileSync('sitemap.xml', xml);
          console.log('âœ… Generated sitemap.xml with', urls.length, 'URLs');
          
          // Generate news sitemap for recent events
          const seoData = JSON.parse(fs.readFileSync('seo-metadata.json', 'utf8'));
          const recentEvents = seoData.events.filter(e => {
            const eventTime = new Date(e.event.start_time);
            const now = new Date();
            const twoDaysAgo = new Date(now - 2 * 24 * 60 * 60 * 1000);
            return eventTime > twoDaysAgo;
          });
          
          let newsXml = '<?xml version="1.0" encoding="UTF-8"?>\n';
          newsXml += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"\n';
          newsXml += '        xmlns:news="http://www.google.com/schemas/sitemap-news/0.9">\n';
          
          recentEvents.forEach(event => {
            newsXml += '  <url>\n';
            newsXml += `    <loc>${event.canonical_url}</loc>\n`;
            newsXml += '    <news:news>\n';
            newsXml += '      <news:publication>\n';
            newsXml += '        <news:name>Tarjeta Roja En Vivo</news:name>\n';
            newsXml += '        <news:language>es</news:language>\n';
            newsXml += '      </news:publication>\n';
            newsXml += `      <news:publication_date>${event.event.start_time}</news:publication_date>\n`;
            newsXml += `      <news:title>${event.meta.title}</news:title>\n`;
            
            // Safely access bing.news_keywords with fallback
            const keywords = event.bing?.news_keywords || event.meta.keywords || '';
            newsXml += `      <news:keywords>${keywords}</news:keywords>\n`;
            
            newsXml += '    </news:news>\n';
            newsXml += '  </url>\n';
          });
          
          newsXml += '</urlset>';
          
          fs.writeFileSync('sitemap-news.xml', newsXml);
          console.log('âœ… Generated sitemap-news.xml with', recentEvents.length, 'recent events');
          EOF
          
          node generate-sitemap.js
      
      - name: Generate robots.txt
        run: |
          cat > robots.txt << 'EOF'
          User-agent: *
          Allow: /
          
          User-agent: bingbot
          Allow: /
          Crawl-delay: 0
          
          User-agent: Googlebot
          Allow: /
          
          Sitemap: https://tarjetarojaenvivo.live/sitemap.xml
          Sitemap: https://tarjetarojaenvivo.live/sitemap-news.xml
          
          Host: https://tarjetarojaenvivo.live
          EOF
          
          echo "âœ… Generated robots.txt"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add seo-metadata.json sitemap-urls.json sitemap.xml sitemap-news.xml robots.txt
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-generate SEO metadata and sitemap [skip ci]"
            git push
          fi
      
      - name: Create summary
        run: |
          echo "## ðŸ“Š SEO Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL=$(jq '.total_events' seo-metadata.json)
          CATEGORIES=$(jq '.categories | length' seo-metadata.json)
          
          echo "- **Total Events:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Categories:** $CATEGORIES" >> $GITHUB_STEP_SUMMARY
          echo "- **Generated At:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Generated Files:" >> $GITHUB_STEP_SUMMARY
          echo "- \`seo-metadata.json\` - Complete SEO metadata" >> $GITHUB_STEP_SUMMARY
          echo "- \`sitemap-urls.json\` - Sitemap URLs data" >> $GITHUB_STEP_SUMMARY
          echo "- \`sitemap.xml\` - XML Sitemap" >> $GITHUB_STEP_SUMMARY
          echo "- \`sitemap-news.xml\` - News Sitemap" >> $GITHUB_STEP_SUMMARY
          echo "- \`robots.txt\` - Robots configuration" >> $GITHUB_STEP_SUMMARY
